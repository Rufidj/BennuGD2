build-windows:
  runs-on: ubuntu-latest
  permissions:
    contents: write

  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          mingw-w64 build-essential cmake autoconf libtool pkg-config \
          unzip wget rar

        # Variables de prefijo
        export MINGW_PREFIX=/usr/x86_64-w64-mingw32

        # Descargar y compilar GLEW para MinGW 64-bit
        wget -q https://github.com/nigels-com/glew/releases/download/2.2.0/glew-2.2.0.zip
        unzip -q glew-2.2.0.zip
        cd glew-2.2.0
        make SYSTEM=mingw64
        sudo make SYSTEM=mingw64 PREFIX=$MINGW_PREFIX install
        cd ..

    - name: Build SDL2 and other dependencies
      run: |
        export MINGW_PREFIX=/usr/x86_64-w64-mingw32
        cd vendor

        # SDL2
        cd SDL2-2.28.4
        sed -i 's,/usr/local,/usr,g' Makefile
        sudo make cross
        cd ..

        # SDL2_mixer
        cd SDL2_mixer-2.6.3
        sed -i 's,/usr/local,/usr,g' Makefile
        sudo make cross
        cd ..

        # SDL2_image
        cd SDL2_image-2.6.3
        sed -i 's,/usr/local,/usr,g' Makefile
        sudo make cross
        cd ..

        # libogg
        wget -q https://downloads.xiph.org/releases/ogg/libogg-1.3.5.tar.gz
        tar -xvzf libogg-1.3.5.tar.gz
        cd libogg-1.3.5
        ./configure --host=x86_64-w64-mingw32 --prefix=$MINGW_PREFIX
        make && sudo make install
        cd ..

        # libvorbis
        wget -q https://downloads.xiph.org/releases/vorbis/libvorbis-1.3.7.tar.gz
        tar -xvzf libvorbis-1.3.7.tar.gz
        cd libvorbis-1.3.7
        ./configure --host=x86_64-w64-mingw32 --prefix=$MINGW_PREFIX
        make && sudo make install
        cd ..

        # libtheora
        wget -q http://downloads.xiph.org/releases/theora/libtheora-1.1.1.tar.gz
        tar -xvzf libtheora-1.1.1.tar.gz
        cd libtheora-1.1.1
        ./configure --host=x86_64-w64-mingw32 --prefix=$MINGW_PREFIX \
          --disable-shared --disable-examples
        make && sudo make install
        cd ../..

    - name: Build BennuGD2
      run: |
        chmod +x ./build.sh ./vendor/build-sdl-gpu.sh
        git submodule update --init --recursive
        cd vendor
        ./build-sdl-gpu.sh windows
        cd ..
        ./build.sh windows
        mkdir -p packages
        rm -f packages/*

        # Empaquetar ejecutables y DLLs
        if [[ -d build/x86_64-w64-mingw32/bin ]]; then
          rar a -ep1 packages/bgd2-x86_64-w64-mingw32-$(date +"%Y-%m-%d").rar \
            build/x86_64-w64-mingw32/bin/*.exe \
            build/x86_64-w64-mingw32/bin/*.dll \
            dependencies/x86_64-w64-mingw32/libSDL2_gpu.dll \
            /usr/x86_64-w64-mingw32/bin/libogg*.dll \
            /usr/x86_64-w64-mingw32/bin/libvorbis*.dll \
            /usr/x86_64-w64-mingw32/bin/SDL2.dll \
            /usr/x86_64-w64-mingw32/bin/SDL2_image.dll \
            /usr/x86_64-w64-mingw32/bin/SDL2_mixer.dll \
            $(find /usr/x86_64-w64-mingw32 -name 'zlib1.dll') \
            /usr/x86_64-w64-mingw32/lib/libwinpthread-*.dll \
            WhatsNew.txt || true
        fi

    - name: Upload BennuGD2 artifacts
      uses: actions/upload-artifact@v4
      with:
        name: BennuGD2-windows
        path: packages/bgd2-x86_64-w64-mingw32-*.rar
